<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Cathy Yeh" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="database, R, SQL, SQLite, web scraping, Methods, Programming, Tools, " />

<meta property="og:title" content="Build a web scraper for a literature search - from soup to nuts "/>
<meta property="og:url" content="./build-a-web-scraper-lit-search.html" />
<meta property="og:description" content="Code, references, and examples of this project are on Github. In this post, I’ll describe the soup to nuts process of automating a literature search in Pubmed Central using R. It feels deeply satisfying to sit back and let the code do the dirty work. Is it as satisfying …" />
<meta property="og:site_name" content="EFAVDB" />
<meta property="og:article:author" content="Cathy Yeh" />
<meta property="og:article:published_time" content="2015-08-25T17:43:00-07:00" />
<meta name="twitter:title" content="Build a web scraper for a literature search - from soup to nuts ">
<meta name="twitter:description" content="Code, references, and examples of this project are on Github. In this post, I’ll describe the soup to nuts process of automating a literature search in Pubmed Central using R. It feels deeply satisfying to sit back and let the code do the dirty work. Is it as satisfying …">

        <title>Build a web scraper for a literature search - from soup to nuts  · EFAVDB
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Fira+Sans:300,400,700" rel="stylesheet" type='text/css' />
        <link href="https://fonts.googleapis.com/css?family=Cardo" rel="stylesheet" type='text/css' />        
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>EFAVDB</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./pages/authors.html">Authors</a></li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="./build-a-web-scraper-lit-search.html">
                Build a web scraper for a literature search - from soup to&nbsp;nuts
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p><em>Code, references, and examples of this project are on <a href="https://github.com/EFavDB/PubmedCentral_Scraper">Github</a>.</em></p>
<p>In this post, I&#8217;ll describe the soup to nuts process of automating a literature search in <a href="http://www.ncbi.nlm.nih.gov/pmc/">Pubmed Central</a> using&nbsp;R.</p>
<p>It feels deeply satisfying to sit back and let the code do the dirty&nbsp;work.</p>
<p>Is it as satisfying as a bowl of red-braised beef noodle soup with melt-in-your-mouth tendons from Taipei&#8217;s Yong Kang Restaurant (featured&nbsp;image)?</p>
<p>If you have to do a lit search like this more than once, then I have to say the answer is yes &#8212; unequivocally,&nbsp;yes.  </p>
<p>The three components of the project&nbsp;are</p>
<p><a href="#Section1">I. Design a database to store the contents of a scraping session</a><br>
<a href="#Section2"><span class="caps">II</span>. Extract information via an <span class="caps">API</span> and web scraper</a><br>
<a href="#Section3"><span class="caps">III</span>. Generate summary&nbsp;reports</a></p>
<p>If you want to skip the explanations and go straight to using the program, check out the quick-start <span class="caps">HTML5</span> <a href="./wp-content/uploads/2015/08/PubmedCentralSlides.html">presentation</a> or <a href="./wp-content/uploads/2015/08/scraper_manual.html">manual</a> and an example of a <a href="https://github.com/EFavDB/PubmedCentral_Scraper/blob/master/example/scraper_TGI_plots_for_trastuzumab.md">report</a> generated by this&nbsp;project.</p>
<hr>
<p>The task is to capture plots of tumor growth inhibition (<span class="caps">TGI</span>), i.e. tumor growth as a function of time, in animals treated with a particular cancer drug, then aggregate all the plots in a summary&nbsp;report.</p>
<p>An example of a <span class="caps">TGI</span> plot is provided below (source: <a href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC3792566/" title="PMC3792566">Qi 2011</a>) for <span class="caps">TGI</span> in mice treated with the cancer drug,&nbsp;Docetaxel.</p>
<p>[caption id=&#8221;attachment_2047&#8221; align=&#8221;alignnone&#8221; width=&#8221;300&#8221; class=&#8221;left&#8221;]<a href="http://efavdb.com/wp-content/uploads/2015/07/TGIplot.png"><img alt="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC3792566/figure/F5/" src="http://efavdb.com/wp-content/uploads/2015/07/TGIplot-300x217.png"></a> <span class="caps">TGI</span> plots for several drugs (image credit: Qi&nbsp;2011)[/caption]</p>
<p>Since the scraper was intended for a casual (non-exhaustive) literature search, I decided to confine the search to online articles in Pubmed Central (as opposed to Pubmed in general) since they are entirely open-access and available in a mostly uniform&nbsp;format.</p>
<hr>
<h2>I. Set up the the&nbsp;database</h2>
<p>This project called for data storage beyond the scope of data frames and external flat files, e.g. Excel spreadsheets or csv files, since the following attributes were required of the&nbsp;data:</p>
<ul>
<li>Persistence outside the R environment =&gt; data frames&nbsp;unsuitable</li>
<li>Ease of access and manipulation =&gt; writing to and reading from text/csv files would be&nbsp;cumbersome</li>
<li>The data would be structured =&gt; relational&nbsp;database</li>
</ul>
<p>With a view towards expediency, we cover just enough to get things up and running and leave the finer details of relational database design to the&nbsp;experts.</p>
<p><a href="http://www.sqlite.org/about.html" title="SQLite">SQLite</a> is well-suited for this small project; it&#8217;s self-contained and doesn&#8217;t require fussing with servers. To lower the barrier even further, the <a href="http://cran.r-project.org/web/packages/RSQLite/index.html" title="RSQLite">RSQLite</a> package embeds SQLite in R (no separate installation needed) and allows you to very easily interface with your database within the R environment. The database itself is stored in a single file on your hard disk and easily&nbsp;transferred.</p>
<h3>What data will be&nbsp;collected?</h3>
<p>The first step is to decide what data should be collected during the web scraping process. We want to aggregate images of plots in a (html)&nbsp;report.</p>
<p>However, downloading the images themselves is inefficient; instead, we&#8217;ll just grab the image URLs on Pubmed Central. (The image URLs are useful because they can be referred to by markdown code to embed the images in the html&nbsp;report.)</p>
<p>The image urls should be captured, along with associated information&nbsp;below:</p>
<hr>
<p><strong>image data</strong>                         image url, figure name in the article, image caption
  <strong>article metadata</strong>                   Pubmed Central id, <span class="caps">DOI</span>, title, journal, year of publication, authors, abstracts, keywords
  <strong>search criteria met by the image</strong>   topic/drug, type of&nbsp;plot</p>
<hr>
<p>The last point addresses the foreseeable need to be able to modify the search parameters. In the next section, we allow for the possibility that the same image might show up for more than one kind of drug or plot&nbsp;type.</p>
<h3>Decide on a layout for the&nbsp;database</h3>
<p>After pinning down the content itself, the next step is to decide how it should be arranged in the database.&nbsp;Namely,</p>
<ul>
<li>What tables are&nbsp;needed?</li>
<li>Which fields go in which&nbsp;tables?</li>
<li>How do the tables relate to one&nbsp;another?</li>
</ul>
<p>This particularly helpful <a href="http://db.grussell.org/section008.html" title="normalization">page</a> walks you through the concept of database normalization by providing lots of concrete examples, including &#8220;anomalies&#8221; that arise in poorly designed&nbsp;databases.</p>
<p>Some ideas on normalization are intuitive. Let&#8217;s take a look at how to restructure a table to satisfy first normal form (<span class="caps">1NF</span>). The table below is not in <span class="caps">1NF</span> because it contains sets of values within single&nbsp;rows.</p>
<p>student_id</p>
<p>name</p>
<p>subjects</p>
<p>grades</p>
<p>1234</p>
<p>Andrew</p>
<p>machine&nbsp;learning</p>
<p>linear&nbsp;algebra</p>
<p>modern&nbsp;physics</p>
<p>A</p>
<p>A</p>
<p>B+</p>
<p>5678</p>
<p>Yaser</p>
<p>statistical&nbsp;physics</p>
<p>algorithms</p>
<p>A-</p>
<p>A</p>
<p>Instead, we can break it up into two&nbsp;tables:</p>
<p>table:&nbsp;student</p>
<p>student_id</p>
<p>name</p>
<p>1234</p>
<p>Andrew</p>
<p>5678</p>
<p>Yaser</p>
<p>table:&nbsp;grades</p>
<p>student_id</p>
<p>subject</p>
<p>grade</p>
<p>1234</p>
<p>machine&nbsp;learning</p>
<p>A</p>
<p>1234</p>
<p>linear&nbsp;algebra</p>
<p>A</p>
<p>1234</p>
<p>modern&nbsp;physics</p>
<p>B+</p>
<p>5678</p>
<p>statistical&nbsp;physics</p>
<p>A-</p>
<p>5678</p>
<p>algorithms</p>
<p>A</p>
<p>Column names that are primary keys are underlined. A primary key is a column, or combination of columns, whose values uniquely identify a row in a table (and accordingly guards against duplicate rows). In a first go at a schema, a table without a logical primary key reared its ugly&nbsp;head:</p>
<p>pmcid</p>
<p>topic</p>
<p>123456</p>
<p>drug&nbsp;A</p>
<p>123456</p>
<p>drug&nbsp;B</p>
<p>100000</p>
<p>drug&nbsp;A</p>
<p>Note that the <strong>pmcid</strong> value is not guaranteed to be unique in the above table because the same article may show up in searches for multiple drugs. This situation hinted at the need to restructure the tables. We finally settled on the three tables below, which all had natural primary keys&nbsp;(underlined):</p>
<p>table:&nbsp;article</p>
<p>pmcid</p>
<p>doi</p>
<p>title</p>
<p>journal</p>
<p>year</p>
<p>authors</p>
<p>abstract</p>
<p>keywords</p>
<p>table:&nbsp;figure</p>
<p>topic</p>
<p>plot_type</p>
<p>img_url</p>
<p>pmcid</p>
<p>table:&nbsp;figure_text</p>
<p>img_url</p>
<p>fig_name</p>
<p>caption</p>
<p>[caption id=&#8221;attachment_2041&#8221; align=&#8221;alignright&#8221; width=&#8221;263&#8221;]<a href="http://efavdb.com/wp-content/uploads/2015/07/a_hanging.jpg"><img alt="cartoon hanging" src="http://efavdb.com/wp-content/uploads/2015/07/a_hanging-263x300.jpg"></a> Their tables were not in <span class="caps">1NF</span>.[/caption]</p>
<p>The tables &#8220;figure&#8221; and &#8220;figure_text&#8221; are kept separate in order to minimize redundancies. For instance, the same img_url can appear in the table &#8220;figure&#8221; multiple times if it matches a number of different drugs or plot types, but its caption would only need to be stored once in the table&nbsp;&#8220;figure_text&#8221;.</p>
<p>The table &#8220;figure&#8221; is not in second normal form (<span class="caps">2NF</span>) because of a partial key dependency; the pmcid field only depends on img_url, rather than the entire composite key {topic, plot_type, and&nbsp;img_url}.</p>
<p>Although the normalization rules sound a bit intimidating, they are just guidelines&#8212;apparently, one can even get carried away with&nbsp;over-normalizing.</p>
<p>The database has held up fine so far, but any suggestions on how to improve the design are very&nbsp;welcome!</p>
<h3>Creating a SQLite database in&nbsp;R</h3>
<p>With a schema in hand, creating the SQLite database in R is a matter of minutes. First, we load the packages for interfacing with the&nbsp;database.</p>
<p>[code lang=&#8221;r&#8221;]<br>
library(<span class="caps">DBI</span>)<br>&nbsp;library(RSQLite)  </p>
<div class="highlight"><pre><span></span><span class="k">Then</span> <span class="n">we</span> <span class="k">create</span> <span class="n">a</span> <span class="k">connection</span> <span class="k">to</span> <span class="n">the</span> <span class="k">database</span><span class="p">,</span> <span class="n">which</span> <span class="n">we</span><span class="err">&#39;</span><span class="n">ll</span> <span class="k">call</span> <span class="ss">&quot;myDb.sqlite&quot;</span><span class="p">.</span>

<span class="p">[</span><span class="n">code</span> <span class="n">lang</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">]</span>  
<span class="n">con</span> <span class="o">=</span> <span class="n">dbConnect</span><span class="p">(</span><span class="n">SQLite</span><span class="p">(),</span> <span class="n">dbname</span> <span class="o">=</span> <span class="ss">&quot;myDb.sqlite&quot;</span><span class="p">)</span>  
</pre></div>


<p>Next, we create the three tables &#8220;article&#8221;, &#8220;figure&#8221;, and&nbsp;&#8220;figure_text&#8221;.</p>
<p>[code&nbsp;language=&#8221;r&#8221;]  </p>
<h2>create <span class="caps">TABLE</span>&nbsp;figure_text</h2>
<p>query = &#8216;<span class="caps">CREATE</span> <span class="caps">TABLE</span> figure_text(img_url <span class="caps">TEXT</span>, fig_name <span class="caps">TEXT</span>, caption <span class="caps">TEXT</span>, <span class="caps">PRIMARY</span> <span class="caps">KEY</span>(img_url))&#8217;<br>
dbGetQuery(con,&nbsp;query)</p>
<h2>create <span class="caps">TABLE</span>&nbsp;figure</h2>
<p>query = &#8216;<span class="caps">CREATE</span> <span class="caps">TABLE</span> figure(topic <span class="caps">TEXT</span>, plot_type <span class="caps">TEXT</span>, img_url <span class="caps">TEXT</span>, pmcid <span class="caps">INTEGER</span>, <span class="caps">PRIMARY</span> <span class="caps">KEY</span>(topic, plot_type, img_url))&#8217;<br>
dbGetQuery(con,&nbsp;query)</p>
<h2>create <span class="caps">TABLE</span>&nbsp;article</h2>
<p>query = &#8216;<span class="caps">CREATE</span> <span class="caps">TABLE</span> article(pmcid <span class="caps">INTEGER</span>, doi <span class="caps">TEXT</span>, title <span class="caps">TEXT</span>, journal <span class="caps">TEXT</span>, year <span class="caps">INTEGER</span>, authors <span class="caps">TEXT</span>, abstract <span class="caps">TEXT</span>, keywords <span class="caps">TEXT</span>, <span class="caps">PRIMARY</span> <span class="caps">KEY</span>(pmcid))&#8217;<br>
dbGetQuery(con,&nbsp;query)  </p>
<div class="highlight"><pre><span></span><span class="k">Last</span><span class="p">,</span> <span class="n">we</span> <span class="k">close</span> <span class="n">the</span> <span class="k">connection</span> <span class="k">to</span> <span class="n">the</span> <span class="k">database</span><span class="p">.</span>

<span class="p">[</span><span class="n">code</span> <span class="n">lang</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">]</span>  
<span class="n">dbDisconnect</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>  
</pre></div>


<p>The SQLite database is now ready to be used! The script above is available on github as <code>createSQLiteDatabase.R</code></p>
<hr>
<h2><span class="caps">II</span>. Scrape Pubmed Central&nbsp;articles</h2>
<p>The script <code>pubmedcentral_scraper.R</code> is where the action happens. It takes input from the user to query the Pubmed Central Database, scrape articles, and load the extracted information into the&nbsp;database.</p>
<h3>Input keywords for literature search and labels in&nbsp;database</h3>
<p>The user input section is shown&nbsp;below.</p>
<p>[code&nbsp;language=&#8221;r&#8221;]  </p>
<h2>&lt;&#8212;&#8212;&#8212;&#8212;-<span class="caps">USER</span> <span class="caps">INPUT</span> <span class="caps">STARTS</span> <span class="caps">HERE</span>&#8212;&#8212;&#8212;&#8212;-&gt;</h2>
<h2>name of database where scraper results are&nbsp;stored</h2>
<p>database.name =&nbsp;&#8220;myDb.sqlite&#8221;</p>
<h2>maximum number of results to retrieve from&nbsp;query</h2>
<p>retmax =&nbsp;10</p>
<h2>topic terms to be queried via the pubmed search&nbsp;engine</h2>
<p>query.topic = c(&#8220;Docetaxel&#8221;,&nbsp;&#8220;Docetaxol&#8221;)</p>
<h2>keywords to identify plot type to be&nbsp;captured</h2>
<h2>terms should be&nbsp;lower-case</h2>
<p>query.plottype = c(&#8220;tumor growth&#8221;, &#8220;tumor volume&#8221;,<br>
&#8220;tumor size&#8221;, &#8220;tumor inhibition&#8221;,<br>
&#8220;tumor growth inhibition&#8221;, &#8220;tgi&#8221;,<br>
&#8220;tumor response&#8221;, &#8220;tumor&nbsp;regression&#8221;)  </p>
<div class="highlight"><pre><span></span><span class="n">The</span> <span class="k">user</span> <span class="k">input</span> <span class="k">for</span> <span class="n">variables</span> <span class="o">`</span><span class="n">query</span><span class="p">.</span><span class="n">topic</span><span class="o">`</span> <span class="k">and</span> <span class="o">`</span><span class="n">query</span><span class="p">.</span><span class="n">plottype</span><span class="o">`</span> <span class="k">are</span> <span class="n">used</span> <span class="k">to</span> <span class="n">construct</span> <span class="n">the</span> <span class="n">query</span> <span class="k">to</span> <span class="n">Pubmed</span> <span class="n">Central</span> <span class="n">via</span> <span class="n">the</span> <span class="n">Entrez</span> <span class="n">Programming</span> <span class="n">Utilities</span> <span class="n">interface</span> <span class="p">(</span><span class="n">details</span> <span class="k">in</span> <span class="n">the</span> <span class="p">[</span><span class="n">E</span><span class="o">-</span><span class="n">utilities</span> <span class="n">guide</span><span class="p">](</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">ncbi</span><span class="p">.</span><span class="n">nlm</span><span class="p">.</span><span class="n">nih</span><span class="p">.</span><span class="n">gov</span><span class="o">/</span><span class="n">books</span><span class="o">/</span><span class="n">NBK25499</span><span class="o">/</span><span class="p">)),</span> <span class="n">made</span> <span class="n">available</span> <span class="n">through</span> <span class="n">the</span> <span class="p">[</span><span class="k">National</span> <span class="n">Center</span> <span class="k">for</span> <span class="n">Biotechnology</span><span class="p">](</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">ncbi</span><span class="p">.</span><span class="n">nlm</span><span class="p">.</span><span class="n">nih</span><span class="p">.</span><span class="n">gov</span><span class="o">/</span><span class="p">)</span> <span class="p">(</span><span class="n">NCBI</span><span class="p">).</span> <span class="k">To</span> <span class="n">maximize</span> <span class="n">hits</span> <span class="k">to</span> <span class="n">the</span> <span class="n">query</span><span class="p">,</span> <span class="n">the</span> <span class="k">user</span> <span class="n">can</span> <span class="n">supply</span> <span class="n">multiple</span> <span class="n">terms</span> <span class="k">for</span> <span class="k">each</span> <span class="k">variable</span><span class="p">.</span>

<span class="p">[</span><span class="n">code</span> <span class="k">language</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">]</span>  
<span class="o">##</span> <span class="n">topic</span><span class="o">/</span><span class="n">drug</span> <span class="n">label</span> <span class="k">for</span> <span class="k">database</span>  
<span class="n">topic</span> <span class="o">=</span> <span class="ss">&quot;Docetaxel&quot;</span>

<span class="o">##</span> <span class="n">plot</span> <span class="k">type</span> <span class="n">label</span> <span class="k">for</span> <span class="k">database</span>  
<span class="n">plot_type</span> <span class="o">=</span> <span class="ss">&quot;TGI&quot;</span>

<span class="o">##</span> <span class="o">&lt;</span><span class="c1">---------USER INPUT ENDS HERE-----------&gt;  </span>
</pre></div>


<p>The variables <code>topic</code> and <code>plot_type</code> label the data in the SQLite database (the labels should be consistent between queries in order to simplify the information retrieval process, e.g. stick to one spelling convention for a particular drug, like &#8220;Docetaxel&#8221;, in&nbsp;myDb.sqlite).</p>
<p>The first E-utility we will use is ESearch, which returns the <span class="caps">PMC</span> ids of articles matching a query, along with other metadata. The E-utilities <span class="caps">API</span> is extremely easy to use. Simply string together the set of parameters (<span class="caps">NCBI</span> database name, utility name, etc.) and go to the <span class="caps">URL</span>.</p>
<p>[code&nbsp;language=&#8221;r&#8221;]  </p>
<h2>compose url for&nbsp;eSearch</h2>
<p>url.esearch = paste0(url.base, esearch, db, &#8220;&amp;&#8221;, retmax,&#8221;&amp;&#8221;, sortmethod, &#8220;&amp;&#8221;,&nbsp;query)</p>
<h2>get and parse xml data returned by&nbsp;eSearch</h2>
<p>data.esearch =&nbsp;getURL(url.esearch)  </p>
<div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">explicit</span> <span class="n">URL</span> <span class="n">constructed</span> <span class="k">from</span> <span class="n">the</span> <span class="n">above</span> <span class="n">example</span> <span class="k">user</span> <span class="k">input</span> <span class="k">is</span><span class="p">:</span>  
<span class="o">*</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">eutils</span><span class="p">.</span><span class="n">ncbi</span><span class="p">.</span><span class="n">nlm</span><span class="p">.</span><span class="n">nih</span><span class="p">.</span><span class="n">gov</span><span class="o">/</span><span class="n">entrez</span><span class="o">/</span><span class="n">eutils</span><span class="o">/</span><span class="n">esearch</span><span class="p">.</span><span class="n">fcgi</span><span class="o">?</span><span class="n">db</span><span class="o">=</span><span class="n">pmc</span><span class="o">&amp;</span><span class="n">retmax</span><span class="o">=</span><span class="mi">10</span><span class="o">&amp;</span><span class="n">sort</span><span class="o">=</span><span class="n">relevance</span><span class="o">&amp;</span><span class="n">term</span><span class="o">=</span><span class="p">(</span><span class="err">\</span><span class="ss">&quot;Docetaxel\&quot;</span><span class="o">+</span><span class="k">OR</span><span class="o">+</span><span class="err">\</span><span class="ss">&quot;Docetaxol\&quot;</span><span class="p">)</span><span class="o">+</span><span class="k">AND</span><span class="o">+</span><span class="p">(</span><span class="err">\</span><span class="ss">&quot;tumor+growth\&quot;</span><span class="o">+</span><span class="k">OR</span><span class="o">+</span><span class="err">\</span><span class="ss">&quot;tumor+volume\&quot;</span><span class="o">+</span><span class="k">OR</span><span class="o">+</span><span class="err">\</span><span class="ss">&quot;tumor+size\&quot;</span><span class="o">+</span><span class="k">OR</span><span class="o">+</span><span class="err">\</span><span class="ss">&quot;tumor+inhibition\&quot;</span><span class="o">+</span><span class="k">OR</span><span class="o">+</span><span class="err">\</span><span class="ss">&quot;tumor+growth+inhibition\&quot;</span><span class="o">+</span><span class="k">OR</span><span class="o">+</span><span class="err">\</span><span class="ss">&quot;tgi\&quot;</span><span class="o">+</span><span class="k">OR</span><span class="o">+</span><span class="err">\</span><span class="ss">&quot;tumor+response\&quot;</span><span class="o">+</span><span class="k">OR</span><span class="o">+</span><span class="err">\</span><span class="ss">&quot;tumor+regression\&quot;</span><span class="p">)</span><span class="o">*</span>

<span class="n">Try</span> <span class="n">copying</span> <span class="k">and</span> <span class="n">pasting</span> <span class="n">the</span> <span class="n">above</span> <span class="n">URL</span> <span class="k">in</span> <span class="n">your</span> <span class="n">browser</span> <span class="k">to</span> <span class="n">see</span> <span class="n">a</span> <span class="n">sample</span> <span class="k">of</span> <span class="n">the</span> <span class="n">xml</span> <span class="n">file</span> <span class="n">returned</span> <span class="k">by</span> <span class="n">E</span><span class="o">-</span><span class="n">utilities</span><span class="p">.</span> <span class="n">Here</span><span class="s1">&#39;s an excerpt of the XML document from a query to ESearch on August 25, 2015:</span>

<span class="s1">[caption id=&quot;attachment_2317&quot; align=&quot;alignnone&quot; width=&quot;164&quot; class=&quot;center&quot;][![ESearch XML file](http://efavdb.com/wp-content/uploads/2015/08/esearchXML-164x300.jpg)]({static}/wp-content/uploads/2015/08/esearchXML.jpg) XML output from a query to PMC via the ESearch API.[/caption]</span>

<span class="s1">We extract the PMC ids, which are sandwiched between the &lt;Id&gt; XML tags, using functions from the XML and rvest packages:</span>

<span class="s1">[code language=&quot;r&quot;]  </span>
<span class="s1">data.xml = xmlParse(data.esearch)  </span>
<span class="s1">## get pmcid&#39;</span><span class="n">s</span>  
<span class="n">pmcids</span> <span class="o">=</span> <span class="k">data</span><span class="p">.</span><span class="n">xml</span> <span class="o">%&gt;%</span> <span class="n">xml_nodes</span><span class="p">(</span><span class="ss">&quot;Id&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">xml_text</span><span class="p">()</span>  
</pre></div>


<p><code>%&gt;%</code> is a pipe operator for chaining commands (from the <a href="https://cran.r-project.org/web/packages/magrittr/index.html">magrittr</a>&nbsp;package).</p>
<p>The URLs of the html article can be simply constructed from their <span class="caps">PMC</span> ids. For example, the html version of the article with <span class="caps">PMC</span> id 3792566 is found at:&nbsp;http://www.ncbi.nlm.nih.gov/pmc/articles/3792566</p>
<h3>Scrape <span class="caps">HTML</span>&nbsp;articles</h3>
<p>The scraping of the <span class="caps">HTML</span> article is performed by <code>scrapeArticle.R</code>. Note, <span class="caps">PMC</span> ids returned by ESearch which have already been scraped for that particular combination of search terms are&nbsp;skipped.</p>
<p>The html version of the <span class="caps">PMC</span> articles only show excerpts of captions, so we have to extract the individual figure URLs in order to scrape their full captions (and search for keyword matches). In order to extract a data element from an html document, we need to identify the tag associated with that&nbsp;element.</p>
<p><a href="http://selectorgadget.com/">SelectorGadget</a> is a nifty tool to help you hone in on the <span class="caps">CSS</span> selectors of interest. Installation is ridiculously easy: just drag the link on the SelectorGadget page to your browser bookmark&nbsp;bar!</p>
<p>For example, let&#8217;s identify the <span class="caps">CSS</span> selector for figure URLs using SelectorGadget in 3 clicks of the mouse. We&#8217;ll demo SelectorGadget on a <span class="caps">PMC</span> <a href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC3792566/">article</a> that is returned in a query on Docetaxel and <span class="caps">TGI</span>.</p>
<p>In the screenshot below, I clicked on the &#8220;Figure 3&#8221; link as a starting point for selecting all such figure URLs. SelectorGadget identified the element as &#8220;.figpopup&#8221; in the gray toolbar at the bottom of the screenshot, highlighted the direct click in green, and highlighted all the other elements in yellow (total: 35 elements). Notice, however, that two links to Figure 4 have been automatically highlighted in the screenshot, one of which is a reference in the body of the&nbsp;text.</p>
<p>[caption id=&#8221;attachment_2250&#8221; align=&#8221;aligncenter&#8221; width=&#8221;381&#8221;]<a href="./wp-content/uploads/2015/08/selectorgadg1.png"><img alt="A click of the &quot;Figure 3&quot; link next to thumbnail highlights it in green, and similar elements are automatically highlighted in yellow." src="./wp-content/uploads/2015/08/selectorgadg1.png"></a> A click of the &#8220;Figure 3&#8221; link next to thumbnail highlights it in green. Similar elements are automatically highlighted in&nbsp;yellow.[/caption]</p>
<p>To reduce the number of redundant figure <span class="caps">URL</span> links, I then clicked on the Figure 4 link in the body of the text in order to exclude it; it is accordingly highlighted in red to signify its&nbsp;exclusion.</p>
<p>The pattern-matching is momentarily worsened since the link to Figure 4 (bottom) is no longer highlighted. SelectorGadget&#8217;s guess for the <span class="caps">CSS</span> selector becomes &#8220;#lgnd_F3 .figpopup&#8221;, of which there is only one element, highlighted in&nbsp;green.</p>
<p>[caption id=&#8221;attachment_2251&#8221; align=&#8221;aligncenter&#8221; width=&#8221;381&#8221;]<a href="./wp-content/uploads/2015/08/selectorgadg2.png"><img alt="Elements excluded from the pattern matching are highlighted in red." src="./wp-content/uploads/2015/08/selectorgadg2.png"></a> Elements excluded from the pattern matching are highlighted in&nbsp;red.[/caption]</p>
<p>After making the pattern match more specific with an exclusion, we have to re-generalize by re-selecting the Figure 4 bottom link. This time, SelectorGadget gets the pattern right with the <span class="caps">CSS</span> selector &#8220;.icnblk_cntnt .figpopup&#8221;, which describes 5 elements on the&nbsp;page.</p>
<p>[caption id=&#8221;attachment_2249&#8221; align=&#8221;aligncenter&#8221; width=&#8221;380&#8221;]<a href="./wp-content/uploads/2015/08/selectorgadg3.png"><img alt="Third time's the charm: SelectorGadget has honed in on the CSS selectors that match the desired figure URLs." src="./wp-content/uploads/2015/08/selectorgadg3.png"></a> Third time&#8217;s the charm: SelectorGadget has honed in on the <span class="caps">CSS</span> selectors that match the desired figure&nbsp;URLs.[/caption]</p>
<p>Using rvest&#8217;s <code>xml_nodes</code> function, we extract components characterized by the <span class="caps">CSS</span> selector <code>.icnblk_cntnt .figpopup</code> &#8212; namely, the URLs of tables and&nbsp;figures.</p>
<p>[code language=&#8221;r&#8221;]<br>
popups.tags = article %&gt;% xml_nodes(&#8220;.icnblk_cntnt&nbsp;.figpopup&#8221;)  </p>
<div class="highlight"><pre><span></span><span class="k">With</span> <span class="k">some</span> <span class="k">more</span> <span class="n">parsing</span> <span class="k">and</span> <span class="n">filtering</span> <span class="k">similar</span> <span class="k">to</span> <span class="n">the</span> <span class="n">above</span><span class="p">,</span> <span class="n">the</span> <span class="k">full</span> <span class="n">image</span> <span class="n">captions</span> <span class="n">can</span> <span class="n">be</span> <span class="n">grepped</span> <span class="k">for</span> <span class="n">keywords</span><span class="p">.</span> <span class="n">Caption</span> <span class="k">and</span> <span class="n">image</span> <span class="n">metadata</span> <span class="k">for</span> <span class="n">keyword</span> <span class="n">matches</span> <span class="k">are</span> <span class="n">stored</span> <span class="k">in</span> <span class="n">the</span> <span class="n">SQLite</span> <span class="k">database</span> <span class="k">by</span> <span class="o">`</span><span class="n">pubmedcentral_scraper</span><span class="p">.</span><span class="n">R</span><span class="o">`</span><span class="p">.</span>

<span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span>

<span class="n">III</span><span class="p">.</span> <span class="n">Generate</span> <span class="n">a</span> <span class="n">report</span> <span class="k">of</span> <span class="n">the</span> <span class="n">scraped</span> <span class="n">results</span>
<span class="c1">---------------------------------------------</span>

<span class="n">The</span> <span class="n">results</span> <span class="k">of</span> <span class="n">the</span> <span class="n">scraping</span> <span class="n">can</span> <span class="n">be</span> <span class="n">examined</span> <span class="k">by</span> <span class="n">directly</span> <span class="n">querying</span> <span class="n">the</span> <span class="n">SQLite</span> <span class="k">database</span><span class="p">.</span>

<span class="n">I</span> <span class="n">also</span> <span class="n">put</span> <span class="n">together</span> <span class="n">an</span> <span class="n">R</span> <span class="n">script</span><span class="p">,</span> <span class="o">`</span><span class="n">markdown_and_plot</span><span class="p">.</span><span class="n">R</span><span class="o">`</span><span class="p">,</span> <span class="n">that</span> <span class="n">automatically</span> <span class="n">creates</span> <span class="n">an</span> <span class="n">html</span> <span class="n">report</span> <span class="k">in</span> <span class="n">the</span> <span class="k">simple</span> <span class="k">case</span> <span class="k">where</span> <span class="k">only</span> <span class="n">one</span> <span class="n">topic</span> <span class="k">and</span> <span class="n">plot_type</span> <span class="n">need</span> <span class="k">to</span> <span class="n">be</span> <span class="n">included</span><span class="p">.</span> <span class="n">The</span> <span class="k">user</span> <span class="k">only</span> <span class="n">has</span> <span class="k">to</span> <span class="k">input</span> <span class="n">the</span> <span class="n">topic</span> <span class="k">and</span> <span class="n">plot_type</span><span class="p">,</span> <span class="k">and</span> <span class="n">the</span> <span class="n">report</span> <span class="k">is</span> <span class="n">subsequently</span> <span class="k">generated</span><span class="p">.</span>

<span class="o">`</span><span class="n">markdown_and_plot</span><span class="p">.</span><span class="n">R</span><span class="o">`</span> <span class="n">calls</span> <span class="k">on</span> <span class="o">`</span><span class="n">generate_markdown_code</span><span class="p">.</span><span class="n">R</span><span class="o">`</span><span class="p">,</span> <span class="n">which</span> <span class="n">extracts</span> <span class="n">the</span> <span class="n">image</span> <span class="n">URLs</span> <span class="k">from</span> <span class="n">the</span> <span class="k">database</span><span class="p">:</span>

<span class="p">[</span><span class="n">code</span> <span class="k">language</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">]</span>  
<span class="n">query</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="s1">&#39;SELECT *\  </span>
<span class="s1">FROM ((figure JOIN article USING (pmcid))\  </span>
<span class="s1">JOIN figure_text USING (img_url))\  </span>
<span class="s1">WHERE (topic = &quot;%s&quot; AND plot_type = &quot;%s&quot;)\  </span>
<span class="s1">ORDER BY pmcid ASC&#39;</span><span class="p">,</span><span class="n">topic</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">)</span>  
<span class="n">images</span> <span class="o">=</span> <span class="n">dbGetQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

<span class="o">##</span> <span class="n">construct</span> <span class="n">image</span> <span class="n">URLs</span>  
<span class="n">img_links</span> <span class="o">=</span> <span class="n">paste0</span><span class="p">(</span><span class="ss">&quot;http://www.ncbi.nlm.nih.gov&quot;</span><span class="p">,</span> <span class="n">images$img_url</span><span class="p">)</span>  
</pre></div>


<p><code>generate_markdown_code.R</code> then loops through the <em>i</em> images per article and, line by line, writes out markdown code of the image URLs and captions.<br>
[code language=&#8221;r&#8221;]<br>
for(i in seq_along(img_links))&nbsp;{  </p>
<h2>&#8230;</h2>
<p>img_md = paste0(&#8220;<img alt="pmcid: &quot;,images$pmcid[i],&quot;" src="`r img_links[" title=",i,&quot;]`)"><br>
cat(img_md, file=outfile, append=T,&nbsp;sep=&#8221;\n&#8221;)  </p>
<h2>&#8230;</h2>
<p>}  </p>
<div class="highlight"><pre><span></span><span class="ss">`markdown_and_plot.R`</span> <span class="k">then</span> <span class="k">reads</span> <span class="k">in</span> <span class="n">the</span> <span class="n">markdown</span> <span class="n">file</span> <span class="k">and</span> <span class="n">renders</span> <span class="n">it</span> <span class="k">into</span> <span class="n">the</span> <span class="n">final</span> <span class="n">html</span> <span class="n">report</span><span class="p">,</span> <span class="n">containing</span> <span class="n">images</span> <span class="n">embedded</span> <span class="n">via</span> <span class="n">href</span> <span class="n">links</span><span class="p">,</span> <span class="k">using</span> <span class="n">the</span> <span class="ss">`knit2html`</span> <span class="n">function</span> <span class="k">in</span> <span class="n">the</span> <span class="n">knitr</span> <span class="n">package</span><span class="p">.</span>

<span class="p">[</span><span class="n">code</span> <span class="n">language</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">]</span>  
<span class="n">html</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="nf">sprintf</span><span class="p">(</span><span class="s2">&quot;scraper_%s_plots_for_%s.html&quot;</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>  
<span class="nf">knit2html</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">html</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span>  
</pre></div>


<p>For a sample report that was generated for topic = Trastuzumab and plot_type = <span class="caps">TGI</span>, see <a href="https://github.com/EFavDB/PubmedCentral_Scraper/blob/master/example/scraper_TGI_plots_for_trastuzumab.md">here</a>. Note, github automatically renders markdown files into html, whereas html files are displayed as source code. However, the file that is actually intended for human perusal outside Github is the <a href="https://github.com/EFavDB/PubmedCentral_Scraper/blob/master/example/scraper_TGI_plots_for_trastuzumab.html">html</a> version, located in the same example subdirectory on&nbsp;Github.</p>
<hr>
<p>A look at the example report shows that there are a few false positives, i.e. images that don&#8217;t actually correspond to plots of <span class="caps">TGI</span>, but the simplistic grep-keyword-method works well overall. There&#8217;s plenty of room for improving the code, but as it stands, this code sure beats compiling reports by&nbsp;hand!</p>
<p>We&#8217;ve talked about the thought process behind building the program, but to put it to use, check it out on <a href="https://github.com/EFavDB/PubmedCentral_Scraper">Github</a>.</p>


             
 
            
                <hr />
    <div class="author_blurb">
        <a href="" target="_blank" rel="nofollow noopener noreferrer">
            <img src=/wp-content/uploads/2014/12/cathy_photo.jpg alt="Cathy Yeh Avatar" title="Cathy Yeh">
            <span class="author_name">Cathy Yeh</span>
        </a>
        Cathy Yeh got a PhD at UC Santa Barbara studying soft-matter/polymer physics. She is currently looking to transition to a career in data science after wrapping up work with the translational modeling group in a pharmaceutical company in San Diego. She enjoys mining big data and big ice cream and seeing how both can help make the world a better place.
    </div>

            






            <hr/>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="./leave-one-out-cross-validation.html" title="Previous: Leave-one-out cross-validation">Leave-one-out cross-validation</a></li>
                <li class="next-article"><a href="./stochastic-geometric-series.html" title="Next: Stochastic geometric series">Stochastic geometric series</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2015-08-25T17:43:00-07:00">Aug 25, 2015</time>
            <h4>Category</h4>
            <a class="category-link" href="./categories.html#methods-programming-tools-ref">Methods, Programming, Tools</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="./tags.html#database-ref">database
                    <span>1</span>
</a></li>
                <li><a href="./tags.html#r-ref">R
                    <span>2</span>
</a></li>
                <li><a href="./tags.html#sql-ref">SQL
                    <span>1</span>
</a></li>
                <li><a href="./tags.html#sqlite-ref">SQLite
                    <span>1</span>
</a></li>
                <li><a href="./tags.html#web-scraping-ref">web scraping
                    <span>1</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="https://twitter.com/efavdb" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Twitter" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1da1f3"/><path fill="#fff" d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>

    <div>
        <span class="site-name">EFAVDB</span> - Everybody's Favorite Data Blog
    </div>



    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>