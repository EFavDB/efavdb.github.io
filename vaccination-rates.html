<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


  <title>Measles vaccination rate by USA state and relation to mean outbreak size</title>


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
<link href="./vaccination-rates.html" rel="canonical" />
  <!-- Feed -->

  <link href="./theme/css/style.css" type="text/css" rel="stylesheet" />

  <!-- Code highlight color scheme -->
      <link href="./theme/css/code_blocks/github.css" rel="stylesheet">


  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->



    <meta name="description" content="In this post, we provide a quick overview of the data and science of measles spread. Making use of python (code provided) we extract...">

    <meta name="author" content="damienrj">





<!-- Open Graph -->
<meta property="og:site_name" content="EFAVDB"/>
<meta property="og:title" content="Measles vaccination rate by USA state and relation to mean outbreak size"/>
<meta property="og:description" content="In this post, we provide a quick overview of the data and science of measles spread. Making use of python (code provided) we extract..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="./vaccination-rates.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2015-02-25 13:40:00-08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="./author/damienrj.html">
<meta property="article:section" content="Case studies"/>
<meta property="og:image" content="./theme/images/post-bg.jpg">

<!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@efavdb">
    <meta name="twitter:title" content="Measles vaccination rate by USA state and relation to mean outbreak size">
    <meta name="twitter:url" content="./vaccination-rates.html">

        <meta name="twitter:image:src" content="./theme/images/post-bg.jpg">

      <meta name="twitter:description" content="In this post, we provide a quick overview of the data and science of measles spread. Making use of python (code provided) we extract...">

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Measles vaccination rate by USA state and relation to mean outbreak size",
  "headline": "Measles vaccination rate by USA state and relation to mean outbreak size",
  "datePublished": "2015-02-25 13:40:00-08:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "damienrj",
    "url": "./author/damienrj.html"
  },
  "image": "./theme/images/post-bg.jpg",
  "url": "./vaccination-rates.html",
  "description": "In this post, we provide a quick overview of the data and science of measles spread. Making use of python (code provided) we extract..."
}
</script>
</head>
<!-- TODO : Body class -->
<body class="home-template">

<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <ul>
          <li><a href="/" role="presentation">Home</a></li>
          <li><a href="/pages/about.html" role="presentation">About & Consulting</a></li>
          <li><a href="/archives.html" role="presentation">Archive</a></li>
          <li><a href="/tags.html" role="presentation">Tags</a></li>
          <li><a href="/pages/linselect.html" role="presentation">linselect - feature selection</a></li>


    </ul>
  </div>
</nav>
    <!-- Progressbar -->
    <div class="progress-container">
        <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header id="post-header" >
      <div class="inner">
        <nav id="navigation">
            <span id="home-button" class="nav-button">
                <a class="home-button" href="./" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
            </span>
          <span id="menu-button" class="nav-button">
            <a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
          </span>
        </nav>
        <h1 class="post-title">Measles vaccination rate by USA state and relation to mean outbreak size</h1>
        <!-- TODO : Proper class for headline -->
        <span class="post-meta">
                <a href="./author/damienrj.html">Damienrj</a>
            | <time datetime="Wed 25 February 2015">Wed 25 February 2015</time>
        </span>
        <!-- TODO : Modified check -->
      </div>
    </header>

  <section id="wrapper">
    <a class="hidden-close"></a>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
            <section class="post-content">
                <p>In this post, we provide a quick overview of the data and science of measles spread. Making use of python (code provided) we extract from a CDC data set the 2012 youth vaccination rate for each USA state -- see figure below. To aid in the interpretation of this data, we also review and describe the results of a generalized ``SIR" model for disease spread. The model -- analyzed in <a href="http://efavdb.com/math-of-measles/">our last post</a> -- predicts that measles outbreaks are supported only if the vaccination rate is below 94%. At higher rates, infection spread is suppressed, and outbreaks do not occur. As seen in the figure, the majority of the states sit just below this critical number, and so are predicted to support youth outbreaks.</p>
<p><a href="http://twitter.com/efavdb">Follow @efavdb</a>  </p>
<p>Follow us on twitter for new submission alerts!</p>
<p>[caption width="800" caption="Measles vaccination rate by USA state for youths under 36 months in age, 2012. Dashed line at 94% is estimated critical vaccination rate needed to suppress outbreaks. The mean USA youth rate is about 91%."][iframe src="https://plot.ly/~damienrj/179" width="90%" height="950"][/caption]</p>
<h4><strong>Introduction: History of measles in America</strong></h4>
<p>Measles is a highly-contagious, serious illness estimated to currently be contracted by about 20 million individuals each year, globally. Just prior to the arrival of the first measles vaccine in 1963 (developed by <a href="http://en.wikipedia.org/wiki/John_Franklin_Enders">John Enders</a> and his colleagues) approximately 500,000 Americans contracted the disease annually, approximately 50,000 of which required hospitalization -- a rate of 1/10. Among these individuals, approximately 500 would die each year, equating to a 1/1000 mortality rate. As yet, there is <a href="http://www.mayoclinic.org/diseases-conditions/measles/basics/treatment/con-20019675">no treatment</a> available to combat the measles virus, once contracted. Consequently, similar hospitalization and mortality rates <a href="http://en.wikipedia.org/wiki/Measles#Epidemiology">continue to hold today</a>. Sadly, the mortality rate among the malnourished can be as high as 1/10.</p>
<p>[caption width="800" caption="Here, the vaccination rate shown is for youths, under 48 months in first brach (up to 1985), and under 36 months in the latter branch."]<br>
[iframe src="https://plot.ly/~damienrj/262" width="90%" height="400" style="float: right;][/caption]</p>
<p>Contemporary contraction rates in the USA are now extremely low, on the order of <a href="http://www.cdc.gov/measles/cases-outbreaks.html">50-500 per year</a>. This is likely a consequence of the strong local adoption of measles vaccinations, with 91% of young children here now receiving the vaccine prior to their third birthday. The most recent large-scale USA outbreak of the disease happened between the years of 1989 and 1991, when the vaccination rates of children were significantly lower, hovering around 70%. This outbreak centered within poorer, urban areas where the vaccination rates were <a href="http://www.cdc.gov/vaccines/pubs/pinkbook/meas.html">substantially lower</a> than the national average. A summary plot of USA contraction counts and youth vaccination rates by year is shown above -- the two curves are highly anti-correlated. Note that this plot is <strong>click and drag zoomable</strong>, which is useful for setting the scale appropriately for recent years. Data <a href="http://jid.oxfordjournals.org/content/189/Supplement_1/S17.long">source 1</a>, <a href="http://www.cdc.gov/mmwr/preview/mmwrhtml/mm6316a4.htm">source 2</a>; no youth vaccination rate data available between 1985-1991. Full-population averages have been in the 90's <a href="http://www.nature.com/news/measles-by-the-numbers-a-race-to-eradication-1.16897">for some decades</a>, likely due to elementary school matriculation requirements.</p>
<h4><strong>Modeling disease spread</strong></h4>
<p>The striking USA historical data suggests a very strong relationship between the vaccination rate within a community and the frequency and size of the measles outbreaks that it supports. In fact, simple models for disease spread suggest a phase-transition-like (exhibiting abrupt changes) outbreak size dependence on vaccination rates. This is illustrated below, where we plot the predicted measles contraction rate against a population's vaccination rate -- as returned by a generalized <a href="http://en.wikipedia.org/wiki/Epidemic_model#The_SIR_model">SIR model for disease spread</a>: Notice that in the far left side of this plot, the model predicts that disease spread is completely suppressed. However, below a critical vaccination rate (the stated 94% mark -- a number consistent with <a href="http://jid.oxfordjournals.org/content/196/10/1433.full">published estimates for measles</a>), outbreaks begin to be supported, growing in size with further decrease of the vaccination rate.</p>
<p>[caption width="800" caption="The generalized SIR model predicts that a measles outbreak size changes in a phase-transition-like manner with vaccination rate. Further, at about 85% vaccination, the outbreak population fraction and the unvaccinated fraction curves cross. At this point, the outbreak captures nearly all unvaccinated and also a finite fraction of the vaccinated, who begin to become infected due to frequent encounters with disease. "]<br>
[iframe src="https://plot.ly/~damienrj/275" width="90%" height="400"][/caption]</p>
<p>A detailed study of the SIR model's <a href="http://efavdb.com/math-of-measles/">solution</a> is not necessary to understand why disease spread exhibits a phase-transition-like form. Qualitatively, this behavior is a consequence of a simple balance of rates: If the rate at which a disease spreads is greater than the rate at which the ill recover, outbreaks grow and expand. However, if patients recover more quickly than they can spread the disease, outbreak expansion is suppressed, and the number of infected individuals will decrease with time. The balance of these competing effects is tuned by the frequency of vaccination, which directly affects the first of these rates -- that at which the disease can spread. Because measles is <a href="http://www.cdc.gov/measles/about/transmission.html">highly contagious</a>, its balance point occurs around the relatively-high 94% mark seen in the figure -- this is the vaccination rate needed to have the average rate of disease spread just equal to the average rate of recovery. An info-graphic illustrating these points can be found <a href="http://www.vaccines.gov/basics/protection/">here</a>.</p>
<h4><strong>Model implications for USA youth</strong></h4>
<p>At the start of this post, we presented CDC estimates for the mean, by-state vaccination rates within the USA. Now that we have reviewed the results of the SIR model, we can begin to appreciate the significance of this data more deeply. First -- as we noted above -- we see that many states have youth vaccination rates that sit just below the critical 94% level, and thus on average should support small measles outbreaks. The graph of the previous section also allows us to estimate the mean size of a measles outbreak (once sparked) within any community below the critical vaccination rate: The further a state is from the 94% mark, the larger its mean outbreak size should be. Although all states are doing reasonably well, when considered on <a href="http://www.npr.org/blogs/goatsandsoda/2015/02/06/384068229/measles-vaccination-rates-tanzania-does-better-than-u-s">a global scale</a>, it is important to realize that many sit in a region of the plot where the response to a decrease in vaccination rate is most dramatic -- the curve's slope is largest just to the right of 94% vaccination. This means, e.g., that a 1% decrease in vaccination rate will result in a greater than 1% increase in the size of the average outbreak supported within that state. This observation is modestly worrisome, as the risk of contraction for all individuals -- even those vaccinated -- is always proportional to the number of cases present in any outbreak.</p>
<p><strong>Important caveats:</strong></p>
<ul>
<li>Vaccination rates fluctuate between cities, neighborhoods, etc. This means that simple state averages may not accurately characterize your local community's vaccination rate -- the quantity most relevant to your personal infection risk. See, for instance, the plot for California by county shown <a href="http://www.huffingtonpost.com/2015/02/03/measles-us-facts_n_6581922.html">here</a>.</li>
<li>Our results are based on a descriptive, but simple model. They are intended only to provide one with a qualitative picture of the forces governing measles spread. Detailed, peer-reviewed treatments (this is just a blog...) can be found in the literature.</li>
<li>Consult a licensed physician for qualified information on vaccines, measles etc.</li>
</ul>
<h4><strong>Discussion</strong></h4>
<p>Interestingly, <a href="http://en.wikipedia.org/wiki/Measles#Cause">humans are the only known carriers</a> of the measles virus. Consequently, with <a href="http://www.nature.com/news/measles-by-the-numbers-a-race-to-eradication-1.16897">growing global vaccination rates</a>, it may one day soon be possible to totally extinguish the disease. Looking back on the historical USA data helps one realize that this would be a truly remarkable accomplishment! In fact, were the USA in isolation, our current vaccination rates would likely be sufficient to bring this about. However, we are not, and sporadic outbreaks continue to occur here, ignited through international travel of infected individuals. These outbreaks can occur because our youth vaccination rates are below the critical 94% level needed to suppress them.</p>
<p>The science of disease spread is very interesting. For those with a mathematical background, we suggest taking a look at <a href="http://efavdb.com/math-of-measles/">our prior post</a>, where we solve the SIR model analytically. Many additional insights into disease spread -- not covered here -- can be gleaned through the study of this model. Likewise, those with a programming background can play with the code that we provide below to sort through the CDC's data sets in different ways. For instance, one can easily alter this code to view how vaccination rates vary by socio-economic background, rather than by state, etc. One can also use the same procedures to sort through many other interesting data sets provided by the CDC and others.</p>
<h4><strong>Methods: Wrangling the CDC measles data sets</strong></h4>
<h5><strong>Grabbing and loading data</strong></h5>
<p>In this section, we outline our numerical analysis of the CDC measles vaccination rate data set. To follow along, you must first download the files.  Current data can be found <a href="http://www.cdc.gov/nchs/nis/data_files.htm">here</a>, and data corresponding to years before 2009 <a href="http://www.cdc.gov/nchs/nis/data_files_09_prior.htm">here</a>.  Three files are needed.  The <a href="ftp://ftp.cdc.gov/pub/Health_Statistics/NCHS/Datasets/nis/nispuf12.dat">Dataset file</a>, the <a href="ftp://ftp.cdc.gov/pub/Health_Statistics/NCHS/Dataset_Documentation/NIS/NISPUF12_CODEBOOK.PDF">Codebook</a> that explains how to read the dataset files, and the <a href="ftp://ftp.cdc.gov/pub/Health_Statistics/NCHS/Dataset_Documentation/NIS/NISPUF12_DUG.PDF">Data User’s Guide</a> which provides details about the data, including methodology and statistics descriptions.</p>
<p>In our analysis, we will make use of a few python packages.  In particular, we will use <a href="http://pandas.pydata.org/">Pandas</a> to construct high performance data structures, called DataFrames. These are easy to use, and they allow for fast, straightforward data manipulation -- both helpful features for data wrangling. We will utilize the groupby DataFrame method, which enables one to easily segment data according to values along different feature directions. To illustrate, we will split our data by state name.  We will then use the <a href="https://plot.ly/">Plot.ly</a> package to generate the interactive plots included above.</p>
<p>To get a feel for the CDC data, a good first step is to look at the data in a text editor.  Doing this, we quickly notice multiple rows of characters having no vernacular significance.  The codebook allows one to interpret these characters.  It also explains that each row corresponds to a different child surveyed, and that each row has a fixed number of entries, many corresponding to different vaccines. We will read these rows in one at a time -- making use of a for loop -- to save on memory. As each line is processed, we keep only what we need -- here that info relevant to the MMR vaccine.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>  
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>  
<span class="kn">import</span> <span class="nn">plotly.plotly</span> <span class="k">as</span> <span class="nn">py</span>  
<span class="kn">from</span> <span class="nn">plotly.graph_objs</span> <span class="kn">import</span> <span class="o">*</span>  
<span class="n">py</span><span class="o">.</span><span class="n">sign_in</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>  
<span class="c1">#Create some empty lists to store the data  </span>
<span class="n">child_ID</span> <span class="o">=</span> <span class="p">[]</span>  
<span class="n">house_ID</span> <span class="o">=</span> <span class="p">[]</span>  
<span class="n">patient_data</span> <span class="o">=</span> <span class="p">[]</span>  
<span class="n">measles</span> <span class="o">=</span> <span class="p">[]</span>  
<span class="n">state</span> <span class="o">=</span> <span class="p">[]</span>  
<span class="n">stratum</span> <span class="o">=</span> <span class="p">[]</span>  
<span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#No virgin islands  </span>
<span class="n">weights_v</span> <span class="o">=</span> <span class="p">[]</span>  
<span class="n">mmr</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">#First we need to read in the data file, and parse the data  </span>
<span class="c1">#using the datasheet  </span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;nispuf12.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>  
<span class="n">child_ID</span><span class="o">.</span><span class="kp">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>  
<span class="n">house_ID</span><span class="o">.</span><span class="kp">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">11</span><span class="p">])</span>  
<span class="n">patient_data</span><span class="o">.</span><span class="kp">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">12</span><span class="p">])</span>  
<span class="n">measles</span><span class="o">.</span><span class="kp">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">260</span><span class="p">:</span><span class="mi">261</span><span class="p">])</span>  
<span class="n">state</span><span class="o">.</span><span class="kp">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">181</span><span class="p">:</span><span class="mi">183</span><span class="p">])</span>  
<span class="n">stratum</span><span class="o">.</span><span class="kp">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">88</span><span class="p">:</span><span class="mi">92</span><span class="p">])</span>  
<span class="n">weights</span><span class="o">.</span><span class="kp">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">50</span><span class="p">:</span><span class="mi">69</span><span class="p">])</span>  
<span class="n">weights_v</span><span class="o">.</span><span class="kp">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">31</span><span class="p">:</span><span class="mi">50</span><span class="p">])</span>  
<span class="n">mmr</span><span class="o">.</span><span class="kp">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">261</span><span class="p">:</span><span class="mi">262</span><span class="p">])</span>  
</pre></div>


<h5><strong>Cleaning data</strong></h5>
<p>Now that everything is parsed and loaded into arrays, we will insert our data into a dictionary with key given by the column header.  We then convert this into a DataFrame. To streamline the process, we will also replace all the missing values with a NAN, and also convert all relevant entries from string to number format.  We will also replace the stateID numbers with their written names.  Lastly, we will remove all the incomplete patient files.</p>
<div class="highlight"><pre><span></span><span class="n">#Create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">dataframe</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">pandas</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="n">manipulation</span><span class="w">  </span>
<span class="n">d</span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;child&#39;</span><span class="err">:</span><span class="n">child_ID</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;house&#39;</span><span class="err">:</span><span class="n">house_ID</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;state&#39;</span><span class="err">:</span><span class="k">state</span><span class="p">,</span><span class="w">  </span>
<span class="s1">&#39;patient_data&#39;</span><span class="err">:</span><span class="n">patient_data</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;measles&#39;</span><span class="err">:</span><span class="n">measles</span><span class="p">,</span><span class="w">  </span>
<span class="s1">&#39;MMR&#39;</span><span class="err">:</span><span class="n">mmr</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;stratum&#39;</span><span class="err">:</span><span class="n">stratum</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;weights&#39;</span><span class="err">:</span><span class="n">weights</span><span class="p">,</span><span class="w">  </span>
<span class="s1">&#39;weights_v&#39;</span><span class="err">:</span><span class="n">weights_v</span><span class="err">}</span><span class="w">  </span>
<span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">);</span><span class="w"></span>

<span class="n">#Clean</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">assign</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">NAN</span><span class="w">  </span>
<span class="k">data</span><span class="o">[</span><span class="n">&#39;measles&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">&#39;measles&#39;</span><span class="o">]</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="w">  </span>
<span class="o">[</span><span class="n">&#39;1&#39;, &#39;0&#39;, &#39;.&#39;</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">1, 0, &#39;NAN&#39;</span><span class="o">]</span><span class="p">)</span><span class="w"></span>

<span class="n">#Convert</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">numberic</span><span class="w"> </span><span class="k">values</span><span class="w">  </span>
<span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">convert_objects</span><span class="p">(</span><span class="n">convert_numeric</span><span class="o">=</span><span class="k">True</span><span class="p">)</span><span class="w"></span>

<span class="n">#Replace</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">state</span><span class="s1">&#39;s name  </span>
<span class="s1">num,name = np.loadtxt(  </span>
<span class="s1">&#39;</span><span class="n">state_ID</span><span class="p">.</span><span class="n">txt</span><span class="s1">&#39;,unpack=True,dtype=str,delimiter=&#39;</span><span class="p">,</span><span class="s1">&#39;)</span>

<span class="s1">data[&#39;</span><span class="k">state</span><span class="s1">&#39;] = data[&#39;</span><span class="k">state</span><span class="s1">&#39;].replace(  </span>
<span class="s1">num.astype(np.int64), name)</span>

<span class="s1">#Find all the values where there is complete provider data.  </span>
<span class="s1">#We will look at only the complete patient records,  </span>
<span class="s1">#and remove records column which is now only one value.  </span>
<span class="s1">ind = np.where(data.patient_data==1)[0]  </span>
<span class="s1">data = data.iloc[ind]  </span>
<span class="s1">data.drop([&#39;</span><span class="n">patient_data</span><span class="err">&#39;]</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="k">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w">  </span>
</pre></div>


<p>Below, we provide some examples of our resulting, cleaned data points. The weight columns here are described further below. The first of these is used for analyses including the Virgin Islands, the other when they are not.</p>
<div class="highlight"><pre><span></span><span class="err">MMR child house measles state stratum weights weights_v  </span>
<span class="err">0 1 11 1 1 Texas 1054 65.155698 120.163273  </span>
<span class="err">1 1 21 2 1 Texas 2055 33.652064 52.360361  </span>
<span class="err">3 1 41 4 1 Massachusetts 1002 216.529889 271.502218  </span>
<span class="err">5 1 61 6 1 Georgia 1025 231.557156 562.130094  </span>
<span class="err">6 1 71 7 1 South Carolina 1030 150.109737 238.018808</span>
</pre></div>


<h5><strong>Weighting to get averaged statistics</strong></h5>
<p>We now have our data cleaned and ready to go. However, some additional work needs to be done before we can evaluate various statistics of interest. This is because the CDC data set is not a random sample, but instead a <a href="http://en.wikipedia.org/wiki/Stratified_sampling">stratified sample</a> -- i.e. one geared towards obtaining reasonable accuracy among many minority groups, and not simply among the averaged population. The weight factors are the key to extracting averaged statistics from this data, as explained in the user guide. For example, the average is essentially just a weighted average, and the standard error can be calculated using a Taylor-Series approach. The easiest way to apply this to our data is to make use of custom functions. Once constructed, these can then be easily applied to different DataFrame groupings.</p>
<div class="highlight"><pre><span></span><span class="n">#Lets</span><span class="w"> </span><span class="n">define</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">caluclate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">vaccination</span><span class="w"> </span><span class="n">rate</span><span class="w">  </span>
<span class="n">#for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">looking</span><span class="w"> </span><span class="k">at</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">standard</span><span class="w"> </span><span class="n">error</span><span class="w">  </span>
<span class="n">def</span><span class="w"> </span><span class="n">calculate_rate_and_error</span><span class="p">(</span><span class="k">data</span><span class="p">)</span><span class="err">:</span><span class="w">  </span>
<span class="n">#The</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">calucated</span><span class="w"> </span><span class="n">useing</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">weighted</span><span class="w"> </span><span class="n">average</span><span class="w">  </span>
<span class="n">rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="p">.</span><span class="n">MMR</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">weights_v</span><span class="p">).</span><span class="nf">sum</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">weights_v</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span><span class="w"></span>

<span class="n">#The</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">calculated</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">formula</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="n">sheet</span><span class="w">  </span>
<span class="k">data</span><span class="o">[</span><span class="n">&#39;Z&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">weights_v</span><span class="o">*</span><span class="p">(</span><span class="k">data</span><span class="p">.</span><span class="n">MMR</span><span class="o">-</span><span class="n">rate</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">weights_v</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span><span class="w">  </span>
<span class="n">zhi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="o">[</span><span class="n">&#39;stratum&#39;,&#39;house&#39;</span><span class="o">]</span><span class="p">).</span><span class="n">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">).</span><span class="n">Z</span><span class="w">  </span>
<span class="n">zh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zhi</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">level</span><span class="o">=</span><span class="s1">&#39;stratum&#39;</span><span class="p">).</span><span class="nf">sum</span><span class="p">()</span><span class="w">  </span>
<span class="n">#Number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">households</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">stratum</span><span class="w">  </span>
<span class="n">nk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zhi</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">level</span><span class="o">=</span><span class="s1">&#39;stratum&#39;</span><span class="p">).</span><span class="nf">count</span><span class="p">()</span><span class="w">  </span>
<span class="n">zh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zh</span><span class="o">/</span><span class="n">nk</span><span class="w"></span>

<span class="n">stratum_labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zh</span><span class="p">.</span><span class="k">index</span><span class="p">.</span><span class="k">values</span><span class="w">  </span>
<span class="nf">var</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">nk</span><span class="p">))</span><span class="w">  </span>
<span class="n">ind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span>
<span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">stratum_labels</span><span class="p">:</span><span class="w">  </span>
<span class="n">delta2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">zhi</span><span class="p">.</span><span class="n">loc</span><span class="o">[</span><span class="n">a</span><span class="o">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zh</span><span class="o">[</span><span class="n">a</span><span class="o">]</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="w">  </span>
<span class="n">delta2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delta2</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span><span class="w">  </span>
<span class="nf">var</span><span class="o">[</span><span class="n">ind</span><span class="o">]=</span><span class="p">(</span><span class="n">nk</span><span class="o">[</span><span class="n">a</span><span class="o">]/</span><span class="p">(</span><span class="n">nk</span><span class="o">[</span><span class="n">a</span><span class="o">]-</span><span class="mf">1.</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">delta2</span><span class="w">  </span>
<span class="n">ind</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="n">standard_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="nf">var</span><span class="p">))</span><span class="w">  </span>
<span class="k">return</span><span class="w"> </span><span class="n">rate</span><span class="p">,</span><span class="w"> </span><span class="n">standard_error</span><span class="w"></span>
</pre></div>


<p>If we apply this function to our whole DataFrame, we will get the national MMR vaccination rate and standard error.</p>
<div class="highlight"><pre><span></span><span class="err">calculate_rate_and_error(data)  </span>
<span class="err">&amp;gt;&amp;gt;(0.90767842904073048, 0.0043003916851249895)  </span>
</pre></div>


<h5><strong>Data segmentation -- stats by group</strong></h5>
<p>But we can also do more! If we first apply the DateFrame's groupby method, we can split the data along any feature of interest. For example, below we split the data along the state column. This generates subgroups for each state. Next, we use the apply method to run our custom function on all the different groups of data. We then clean up the output, unzip the tuple and generate a graph showing the MMR vaccination rate by state. It should be evident that with only modest effort, one can modify this code to group the data in many varying ways -- all that needs to be done is to adjust the arguments of the groupby command.</p>
<div class="highlight"><pre><span></span><span class="n">#Now</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">easy</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">calculate</span><span class="w"> </span><span class="k">values</span><span class="w">  </span>
<span class="n">#for</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="k">group</span><span class="p">.</span><span class="w"></span>

<span class="n">#To</span><span class="w"> </span><span class="n">examine</span><span class="w"> </span><span class="n">rates</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">state</span><span class="p">,</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">state</span><span class="w">  </span>
<span class="n">grouped</span><span class="o">=</span><span class="k">data</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">)</span><span class="w"></span>

<span class="n">#We</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">apply</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">grouped</span><span class="w"> </span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="k">save</span><span class="w">  </span>
<span class="n">#it</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="n">frame</span><span class="w">  </span>
<span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grouped</span><span class="p">.</span><span class="n">apply</span><span class="p">(</span><span class="n">calculate_rate_and_error</span><span class="p">))</span><span class="w"></span>

<span class="n">#To</span><span class="w"> </span><span class="n">conver</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="k">from</span><span class="err">:</span><span class="w">  </span>
<span class="n">#state</span><span class="w">  </span>
<span class="n">#Alabama</span><span class="w"> </span><span class="p">(</span><span class="mf">0.931323319509</span><span class="p">,</span><span class="w"> </span><span class="mf">0.017837146103</span><span class="p">)</span><span class="w">  </span>
<span class="n">#Alaska</span><span class="w"> </span><span class="p">(</span><span class="mf">0.862202058663</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0257844894834</span><span class="p">)</span><span class="w">  </span>
<span class="n">#to</span><span class="w">  </span>
<span class="err">#</span><span class="w"> </span><span class="n">Rate</span><span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">Error</span><span class="w">  </span>
<span class="n">#state</span><span class="w">  </span>
<span class="n">#Alabama</span><span class="w"> </span><span class="mf">0.931323</span><span class="w"> </span><span class="mf">0.017837</span><span class="w">  </span>
<span class="n">#Alaska</span><span class="w"> </span><span class="mf">0.862202</span><span class="w"> </span><span class="mf">0.025784</span><span class="w">  </span>
<span class="n">#We</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">code</span><span class="w"></span>

<span class="n">new_col_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">&#39;Rate&#39;,&#39;Standard Error&#39;</span><span class="o">]</span><span class="w">  </span>
<span class="k">for</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="n">col</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">new_col_list</span><span class="p">)</span><span class="err">:</span><span class="w">  </span>
<span class="k">result</span><span class="o">[</span><span class="n">col</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">result</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lambda</span><span class="w"> </span><span class="nl">x</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="p">)</span><span class="w">  </span>
<span class="k">result</span><span class="p">.</span><span class="k">drop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">inplace</span><span class="o">=</span><span class="k">True</span><span class="p">)</span><span class="w"></span>

<span class="n">#Make</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sorted</span><span class="w"> </span><span class="n">copy</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">data</span><span class="w">  </span>
<span class="n">sorted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">result</span><span class="p">.</span><span class="n">sort_index</span><span class="p">(</span><span class="k">by</span><span class="o">=</span><span class="s1">&#39;Rate&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ascending</span><span class="o">=</span><span class="k">True</span><span class="p">)</span><span class="w">  </span>
<span class="k">result</span><span class="o">[</span><span class="n">&#39;Rate&#39;</span><span class="o">]=</span><span class="k">result</span><span class="o">[</span><span class="n">&#39;Rate&#39;</span><span class="o">]*</span><span class="mi">100</span><span class="w"></span>

<span class="n">#Save</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">csv</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">wanted</span><span class="w">  </span>
<span class="k">result</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;Rate 2012.csv&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;%5.2f&#39;</span><span class="p">)</span><span class="w"></span>

<span class="n">#Generate</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">online</span><span class="w"> </span><span class="n">plot</span><span class="w">  </span>
<span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">Data</span><span class="p">(</span><span class="o">[</span><span class="n">  </span>
<span class="n">Bar(  </span>
<span class="n">y=sorted.index.values ,  </span>
<span class="n">x=sorted[&#39;Rate&#39;</span><span class="o">]</span><span class="p">,</span><span class="w">  </span>
<span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="w">  </span>
<span class="p">)</span><span class="w">  </span>
<span class="err">]</span><span class="p">)</span><span class="w">  </span>
<span class="n">plot_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">py</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;plot&#39;</span><span class="p">)</span><span class="w">  </span>
</pre></div>


<p>featured image credit: Pete Lewis / Department for International Development</p>
            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=Measles vaccination rate by USA state and relation to mean outbreak size&amp;url=./vaccination-rates.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=./vaccination-rates.html" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
                    </a>
                    <a class="googleplus" href="https://plus.google.com/share?url=./vaccination-rates.html" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <i class="ic ic-googleplus"></i><span class="hidden">Google+</span>
                    </a>
                    <div class="clear"></div>
                </div>


                <div class="clear"></div>


                </section>


                <aside class="post-nav">
                    <a class="post-nav-next" href="./nba-week-15-summary-week-16-predictions.html">
                        <section class="post-nav-teaser">
                            <i class="ic ic-arrow-left"></i>
                                <h2 class="post-nav-title">NBA week 15 summary, week 16 predictions</h2>
                            <p class="post-nav-excerpt">Not a terribly impressive week for the NBA algorithm. We went 31/53, equating to 58%...</p>
                        </section>
                    </a>
                    <a class="post-nav-prev" href="./math-of-measles.html">
                        <section class="post-nav-teaser">
                            <i class="ic ic-arrow-right"></i>
                                <h2 class="post-nav-title">Mathematics of measles</h2>
                            <p class="post-nav-excerpt">Here, we introduce -- and outline a solution to -- a generalized SIR model for...</p>
                        </section>
                    </a>
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
      <!-- TODO : Body class -->
    <div id="body-class" style="display: none;" class=""></div>

    <footer id="footer">
      <div class="inner">
        <section class="credits">
        </section>
      </div>
    </footer>
  </section>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script type="text/javascript" src="./theme/js/script.js"></script>

</body>
</html>